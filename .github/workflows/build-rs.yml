name: build dpa.opcua.rs

on:
  release:
    types: [created]

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: checkout local
      uses: actions/checkout@v3
      with:
        path: "./.localrepo"
    - name: checkout
      uses: actions/checkout@v3
      with:
        repository: "x-tensive/open62541-servers"
        ref: "master"
        submodules: false
        token: ${{ secrets.BUILDER_TOKEN }}
        path: "./.mainrepo"
        
    - name: update version
      uses: actions/github-script@v6
      with:
        script: |
          const updateVersion = require("./.localrepo/.github/scripts/updateCsprojVersion");
          updateVersion("./.mainrepo/tools/rs/rs.csproj", "${{ github.event.release.tag_name }}");

    - name: add dotnet
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '6.0.x'
    
    - name: build dpa.opcua.rs
      run: dotnet build --configuration Release ./.mainrepo/tools/rs/rs.sln

    - name: sign dpa.opcua.rs.dll
      uses: ./.localrepo/.github/actions/sign-module
      with:
        path: ./.mainrepo/tools/rs/bin/Release/net6.0/dpa.opcua.rs.dll
    
    - name: sign dpa.opcua.rs.exe
      uses: ./.localrepo/.github/actions/sign-module
      with:
        path: ./.mainrepo/tools/rs/bin/Release/net6.0/dpa.opcua.rs.exe
    
    - name: zip assets
      shell: pwsh
      run: Compress-Archive -Path "./.mainrepo/tools/rs/bin/Release/net6.0/*" -DestinationPath dpa.opcua.rs_${{ github.event.release.tag_name }}.zip
    
    - name: upload
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: dpa.opcua.rs_${{ github.event.release.tag_name }}.zip
        asset_name: dpa.opcua.rs_${{ github.event.release.tag_name }}.zip
        asset_content_type: application/octet-stream
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}