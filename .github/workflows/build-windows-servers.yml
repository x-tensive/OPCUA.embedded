name: build windows servers

on:
  release:
    types: [created]

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: checkout
      uses: actions/checkout@v3
      with:
        repository: "x-tensive/open62541-servers"
        ref: "master"
        submodules: recursive
        token: ${{ secrets.BUILDER_TOKEN }}
        
    - name: update version
      shell: pwsh
      run: ./.buildtools/github/updateVersion.ps1 "${{ github.event.release.tag_name }}"
        
    - name: add msbuild
      uses: microsoft/setup-msbuild@v1.1
      
    - name: build SINUMERIK S7 ONLINX XPSP3
      run: msbuild ua_sinumerikServer/ua_sinumerikServer_onlinx.sln -t:rebuild -property:Configuration="Release XPSP3" -property:Platform=x86
    - name: build SINUMERIK S7 ONLINX W2K
      run: msbuild ua_sinumerikServer/ua_sinumerikServer_onlinx.sln -t:rebuild -property:Configuration="Release W2K" -property:Platform=x86

    - name: installer SINUMERIK S7 ONLINX XPSP3
      run: msbuild installer/engine.all/s7onlinx.xpsp3.msbuild
    - name: installer SINUMERIK S7 ONLINX W2K
      run: msbuild installer/engine.all/s7onlinx.w2k.msbuild
      
    - name: upload SINUMERIK S7 ONLINX XPSP3
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }} 
        asset_path: ./.out/installer/s7onck.Win32.xpsp3/dpa.ua.s7onck.install32.exe
        asset_name: dpa.ua.s7onck.install32.xpsp3_${{ github.event.release.tag_name }}.exe 
        asset_content_type: application/octet-stream
    - name: upload SINUMERIK S7 ONLINX W2K
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }} 
        asset_path: ./.out/installer/s7onck.Win32.w2k/dpa.ua.s7onck.install32.exe
        asset_name: dpa.ua.s7onck.install32_w2k_${{ github.event.release.tag_name }}.exe 
        asset_content_type: application/octet-stream
